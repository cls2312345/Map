<!DOCTYPE html>
<html>
<head>
    <title>Quick Live Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; background: #1a1a1a; }
        #map { height: 100vh; width: 100vw; }
        .info-panel {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
            border-radius: 8px; border: 1px solid #444;
        }
    </style>
</head>
<body>

    <div class="info-panel">
        <h3 id="display-name">Joining...</h3>
        <p style="font-size: 0.8em; color: #aaa;">Sharing ghosted location</p>
    </div>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- SETTINGS ---
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiMHNjYW0iLCJhIjoiY21qbmZuamphM2V4eTNlb3R2cHRwNGtmbSJ9.zAtXjUGBzS4csG_TseOJFw'; 
        const socket = io();
        
        // Ask for a name immediately
        const userName = prompt("Enter a nickname to show on the map:") || "Guest";
        document.getElementById('display-name').innerText = "Logged in as: " + userName;

        const map = L.map('map', { zoomControl: false }).setView([0,0], 2);
        L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/dark-v11/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, {
            tileSize: 512, zoomOffset: -1
        }).addTo(map);

        const markers = {};

        // --- GHOSTING & SENDING ---
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((pos) => {
                // Rounding coordinates for privacy
                const lat = Math.round(pos.coords.latitude / 0.001) * 0.001;
                const lng = Math.round(pos.coords.longitude / 0.001) * 0.001;
                
                socket.emit('send-location', { lat, lng, name: userName });
            }, (err) => alert("Please allow GPS to use the map."), { 
                enableHighAccuracy: true 
            });
        }

        // --- RECEIVING OTHERS ---
        socket.on('receive-location', (data) => {
            const { id, lat, lng, name } = data;
            
            if (markers[id]) {
                markers[id].setLatLng([lat, lng]);
            } else {
                // Create a marker for the new person
                markers[id] = L.circleMarker([lat, lng], {
                    radius: 10,
                    color: '#00d2ff',
                    fillOpacity: 0.8
                }).addTo(map);
                
                markers[id].bindTooltip(name, { permanent: true, direction: 'top' });
            }
        });

        socket.on('user-disconnected', (id) => {
            if (markers[id]) {
                map.removeLayer(markers[id]);
                delete markers[id];
            }
        });
    </script>
</body>
</html>